{% extends "admin/base.html" %}
{% load static %}

{% block title %}商品管理 - Django商城后台管理{% endblock %}

{% block content %}
<div class="products-page">
    <!-- 页面标题和操作按钮 -->
    <div class="page-header">
        <div class="header-left">
            <h2>商品管理</h2>
            <p class="page-description">管理商城中的所有商品信息</p>
        </div>
        <div class="header-right">
            <el-button type="primary" icon="el-icon-plus" @click="addProduct">
                添加商品
            </el-button>
            <el-button type="success" icon="el-icon-refresh" @click="refreshData">
                刷新数据
            </el-button>
        </div>
    </div>

    <!-- 统计信息 -->
    <el-row :gutter="20" style="margin-bottom: 20px;">
        <el-col :span="6">
            <el-card class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon">
                        <i class="el-icon-goods"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number">{{ product_count }}</div>
                        <div class="stat-label">商品总数</div>
                    </div>
                </div>
            </el-card>
        </el-col>
        <el-col :span="6">
            <el-card class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon">
                        <i class="el-icon-shopping-bag-1"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number">{{ active_products_count|default:"0" }}</div>
                        <div class="stat-label">上架商品</div>
                    </div>
                </div>
            </el-card>
        </el-col>
        <el-col :span="6">
            <el-card class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon">
                        <i class="el-icon-shopping-cart-2"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number">{{ low_stock_count|default:"0" }}</div>
                        <div class="stat-label">库存不足</div>
                    </div>
                </div>
            </el-card>
        </el-col>
        <el-col :span="6">
            <el-card class="stat-card">
                <div class="stat-content">
                    <div class="stat-icon">
                        <i class="el-icon-money"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-number">{{ total_value|default:"¥0" }}</div>
                        <div class="stat-label">商品总值</div>
                    </div>
                </div>
            </el-card>
        </el-col>
    </el-row>

    <!-- 搜索和筛选 -->
    <el-card style="margin-bottom: 20px;">
        <el-row :gutter="20">
            <el-col :span="6">
                <el-input
                    v-model="searchQuery"
                    placeholder="搜索商品名称"
                    prefix-icon="el-icon-search"
                    @input="handleSearch">
                </el-input>
            </el-col>
            <el-col :span="4">
                <el-select v-model="categoryFilter" placeholder="选择分类" @change="handleFilter">
                    <el-option label="全部分类" value=""></el-option>
                    <el-option label="电子产品" value="电子产品"></el-option>
                    <el-option label="服装鞋包" value="服装鞋包"></el-option>
                    <el-option label="家居用品" value="家居用品"></el-option>
                </el-select>
            </el-col>
            <el-col :span="4">
                <el-select v-model="statusFilter" placeholder="选择状态" @change="handleFilter">
                    <el-option label="全部状态" value=""></el-option>
                    <el-option label="已上架" value="active"></el-option>
                    <el-option label="已下架" value="inactive"></el-option>
                </el-select>
            </el-col>
            <el-col :span="4">
                <el-button type="primary" @click="handleFilter">筛选</el-button>
                <el-button @click="clearFilter">清除</el-button>
            </el-col>
        </el-row>
    </el-card>

    <!-- 商品列表 -->
    <el-card>
        <div slot="header">
            <span>商品列表</span>
            <el-button style="float: right; padding: 3px 0" type="text" @click="exportData">
                导出数据
            </el-button>
        </div>
        
        <el-table :data="products" style="width: 100%" v-loading="loading">
            <el-table-column prop="id" label="ID" width="80"></el-table-column>
            <el-table-column prop="name" label="商品名称" min-width="200">
                <template slot-scope="scope">
                    <div class="product-info">
                        <div class="product-name">{{ scope.row.name }}</div>
                        <div class="product-description">{{ scope.row.description }}</div>
                    </div>
                </template>
            </el-table-column>
            <el-table-column prop="category" label="分类" width="120"></el-table-column>
            <el-table-column prop="price" label="价格" width="120">
                <template slot-scope="scope">
                    <span class="price">¥{{ scope.row.price }}</span>
                </template>
            </el-table-column>
            <el-table-column prop="stock" label="库存" width="100">
                <template slot-scope="scope">
                    <el-tag :type="getStockType(scope.row.stock)" size="small">
                        {{ scope.row.stock }}
                    </el-tag>
                </template>
            </el-table-column>
            <el-table-column prop="is_active" label="状态" width="100">
                <template slot-scope="scope">
                    <el-tag :type="scope.row.is_active ? 'success' : 'info'" size="small">
                        {{ scope.row.is_active ? '已上架' : '已下架' }}
                    </el-tag>
                </template>
            </el-table-column>
            <el-table-column prop="created_at" label="创建时间" width="180"></el-table-column>
            <el-table-column label="操作" width="200" fixed="right">
                <template slot-scope="scope">
                    <el-button size="mini" @click="editProduct(scope.row)">编辑</el-button>
                    <el-button size="mini" type="success" @click="toggleStatus(scope.row)">
                        {{ scope.row.is_active ? '下架' : '上架' }}
                    </el-button>
                    <el-button size="mini" type="danger" @click="deleteProduct(scope.row)">删除</el-button>
                </template>
            </el-table-column>
        </el-table>
        
        <!-- 分页 -->
        <el-pagination
            @size-change="handleSizeChange"
            @current-change="handleCurrentChange"
            :current-page="currentPage"
            :page-sizes="[10, 20, 50, 100]"
            :page-size="pageSize"
            layout="total, sizes, prev, pager, next, jumper"
            :total="total">
        </el-pagination>
    </el-card>
</div>

<style>
.products-page {
    padding: 0;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.page-header h2 {
    margin: 0 0 5px 0;
    color: #333;
}

.page-description {
    margin: 0;
    color: #666;
    font-size: 14px;
}

.product-info {
    display: flex;
    flex-direction: column;
}

.product-name {
    font-weight: 500;
    color: #333;
    margin-bottom: 5px;
}

.product-description {
    font-size: 12px;
    color: #999;
    line-height: 1.4;
}

.price {
    font-weight: bold;
    color: #e60012;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// 商品管理页面数据和方法
document.addEventListener('DOMContentLoaded', function() {
    // 等待Vue实例初始化完成
    setTimeout(function() {
        if (window.AdminApp && window.AdminApp.$data) {
            // 扩展Vue实例的数据
            Object.assign(window.AdminApp.$data, {
                // 商品管理相关数据
                loading: false,
                searchQuery: '',
                categoryFilter: '',
                statusFilter: '',
                currentPage: 1,
                pageSize: 10,
                total: 0,
                products: [
                    {% for product in products %}
                    {
                        id: {{ product.id }},
                        name: '{{ product.name }}',
                        description: '{{ product.description }}',
                        category: '{{ product.category.name }}',
                        price: {{ product.price }},
                        stock: {{ product.stock }},
                        is_active: {{ product.is_active|lower }},
                        created_at: '{{ product.created_at|date:"Y-m-d H:i" }}'
                    },
                    {% endfor %}
                ]
            });

            // 扩展Vue实例的方法
            Object.assign(window.AdminApp, {
                // 添加商品
                addProduct() {
                    window.location.href = '/admin/products/product/add/';
                },
                
                // 编辑商品
                editProduct(product) {
                    window.location.href = `/admin/products/product/${product.id}/change/`;
                },
                
                // 切换商品状态
                toggleStatus(product) {
                    const action = product.is_active ? '下架' : '上架';
                    this.$confirm(`确定要${action}商品"${product.name}"吗？`, '提示', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消',
                        type: 'warning'
                    }).then(() => {
                        // 这里可以发送AJAX请求来更新状态
                        product.is_active = !product.is_active;
                        this.$message.success(`商品已${action}`);
                    }).catch(() => {
                        this.$message.info('已取消操作');
                    });
                },
                
                // 删除商品
                deleteProduct(product) {
                    this.$confirm(`确定要删除商品"${product.name}"吗？此操作不可恢复！`, '警告', {
                        confirmButtonText: '确定删除',
                        cancelButtonText: '取消',
                        type: 'error'
                    }).then(() => {
                        // 这里可以发送AJAX请求来删除商品
                        const index = this.products.findIndex(p => p.id === product.id);
                        if (index > -1) {
                            this.products.splice(index, 1);
                        }
                        this.$message.success('商品已删除');
                    }).catch(() => {
                        this.$message.info('已取消删除');
                    });
                },
                
                // 搜索
                handleSearch() {
                    this.currentPage = 1;
                },
                
                // 筛选
                handleFilter() {
                    this.currentPage = 1;
                },
                
                // 清除筛选
                clearFilter() {
                    this.searchQuery = '';
                    this.categoryFilter = '';
                    this.statusFilter = '';
                    this.currentPage = 1;
                },
                
                // 刷新数据
                refreshData() {
                    this.loading = true;
                    setTimeout(() => {
                        this.loading = false;
                        this.$message.success('数据已刷新');
                    }, 1000);
                },
                
                // 导出数据
                exportData() {
                    this.$message.info('导出功能开发中...');
                },
                
                // 获取库存标签类型
                getStockType(stock) {
                    if (stock <= 0) return 'danger';
                    if (stock <= 10) return 'warning';
                    return 'success';
                },
                
                // 分页处理
                handleSizeChange(val) {
                    this.pageSize = val;
                },
                
                handleCurrentChange(val) {
                    this.currentPage = val;
                }
            });

            // 初始化总数
            window.AdminApp.total = window.AdminApp.products.length;
        }
    }, 100);
});
</script>
{% endblock %} 